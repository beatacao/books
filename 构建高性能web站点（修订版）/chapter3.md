# 服务器并发处理能力  

## 3.1 吞吐率  
    . 吞吐率：web服务器单位时间内处理的请求数，（reqs/s）  
    . 最大吞吐率：吞吐率，仅表示了服务器在实际运行期间单位时间内处理的请求数。我们有时更关心的是最大吞吐率（即服务器在单位时间内所能处理的最大请求数），一般通过压力测试（模拟足够数量的并发请求，持续请求一段时间，最后求平均值）来得出  
    . 因为web服务器受理的请求的多样化，用压力测试模拟真实运行的并发非常困难。（在有多个变量的数据模型种求最优结果是很困难的，我们一般简化模型，对有代表性的特定类型请求，分别进行压力测试，求出最大吞吐率。最后根据需要，对各个吞吐率按照比例求加权平均值）  
    . 也正式因为web服务器需要受理请求的多样化，需要针对不同请求做不同的优化。（就像银行柜台，针对不同的业务有特殊的窗口。如果每个窗口都可以受理所有业务，整体效率势必会下降，因为每个银行柜台服务人员不可能了解银行的所有业务）  

### 压力测试前提条件  
    我们要进行压力测试，需要有一些前提条件：压力描述（并发用户数和总请求数）和请求性质描述（请求资源描述），即： 

    . 并发用户数  
    . 总请求数  
    . 请求资源描述  

### 并发用户数（别名：并发数，连接数）   

    . 单位时间内同时向服务器发送请求的用户数。（注意和吞吐率区分，吞吐率是单位时间内服务器可处理请求的一个量化表示）。  
    . 最大并发用户数：‘最大’是服务和用户之间经过权衡的一个平衡点。（银行柜台例子）  
    . 通过压力测试得到的最大并发用户数，并不能代表服务器真实并发用户数。得出最大并发用户数的意义，在于了解服务器的承载能力，并结合实际用户规模考虑适当的扩展方案，从商业角度来看，最大并发数比吞吐率更容易理解。  
    . 最大并发用户数和最大并发连接数的决定性因素是有区分的 -- 请求的性质：服务器处理每个请求需要的时间。  

### 请求等待时间  

    关注两个指标：  
    . 用户平均请求等待时间： 用于衡量在一定并发用户数量的情况下，服务器对于单个用户的服务质量    
    . 服务器平均请求处理时间：用户衡量服务器的整体服务质量  

### 进行压力测试 （例： apache ab，主要用户服务器端性能压测，还有一些运行在客户端的压测软件。）  

    本次压测，主要针对服务器请求处理能力的测试，不包含客户端：
    . 压力测试使用指标：请求总数，并发用户数，请求资源  
    . 过程：增加请求并发用户数，观察压测结果中服务器性能的各项指标，如： 吞吐率，服务器平均请求处理时间，用户平均请求等待时间，找到平衡点：最大并发用户数  
    . 在一定用户并发数下，影响服务器各种性能指标的因素，除去硬件外，就是服务器的并发策略了。  
    . 并发策略，即在服务器需要同时处理较多请求的时候，如何合理协调并充分利用cpu计算和I/O操作，使其在较大并发用户数的情况下有较大的吞吐率。  


## 3.2 cpu并发计算  
    
    服务器能够同时处理多个请求，原因在于操作系统的多执行流体系设计允许多个任务轮流使用系统资源，这些资源包括：cpu, 内存和 I/O等。  

### 进程  
    
    . 多执行流的一般实现即进程。多进程的好处不只在于对资源的轮流使用，也在于对cpu和I/O的叠加利用。（I/O包括磁盘I/O和网络I/O, I/O的速度和cpu速度相比，犹如老牛漫步和超音速飞机相距甚远）。  
    . 使用fork()系统调用创建进程。进程之间是互不影响的，可以通信，但不能干涉彼此的内存空间。因此，当大量使用进程时，会因内存占用太多而有性能问题。  
    . 使用clone()系统调用创建轻量级进程。这些进程之间可以共享一部分数据，较一般进程省去一部分内存控件。但当大量使用进程时，仍会因为进程之间需要频繁切换而影响性能。  
    . 进程的调度由内核直接来进行，从内核的观点看，进程的目的就是担当分配系统资源的实体。  

### 线程  

    分为用户态线程和内核级线程：  
    用户态线程：从内核的角度，多个用户态线程就是一个进程，这些线程由用户态使用一些库函数模拟实现的多执行流。因为不由内核直接分配资源，在多处理器服务器（SMP）上表现较差。  
    内核级线程：使用clone创建，可见内核级线程实现的原理，即把线程和轻量级进程进行一对一关联，每个线程实际上就是一个轻量级进程，由于由内核直接分配资源，对于SMP支持良好。但是在线程切换上，比用户态线程开销多一些。  



